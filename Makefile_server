#
# Copyright (C) 2011 OpenWrt.org
#
# This is free software, licensed under the GNU General Public License v2.
# See /LICENSE for more information.
#

include $(TOPDIR)/rules.mk

PKG_NAME:=tvheadend
#PKG_REV:=bf3def4030d0e28c6173b68f8f31159c23abd02b


#PKG_REV:=e14391323fbe80f8df61e8416bc9d33e9a44a1be
PKG_REV:=a13f3b81190ef0306967e17f696346fe1ab7f13e
PKG_VERSION:=20120921
PKG_RELEASE:=1

PKG_SOURCE_PROTO:=git
PKG_SOURCE_VERSION:=$(PKG_REV)
PKG_SOURCE_SUBDIR:=$(PKG_NAME)-$(PKG_VERSION)
PKG_SOURCE:=$(PKG_NAME)-$(PKG_REV).tar.bz2
PKG_SOURCE_URL:=https://github.com/tvheadend/tvheadend.git

include $(INCLUDE_DIR)/package.mk
include $(INCLUDE_DIR)/nls.mk

define Package/tvheadend/template
  SECTION:=multimedia
  CATEGORY:=Multimedia
  TITLE:=Tvheadend is a TV streaming server for Linux
  URL:=https://www.lonelycoder.com/hts/tvheadend_overview.html
endef

define Package/tvheadend-daemon
  $(call Package/tvheadend/template)
  DEPENDS:=$(ICONV_DEPENDS) +libopenssl +librt
endef

define Package/tvheadend-web
  $(call Package/tvheadend/template)
  DEPENDS:=tvheadend-daemon
endef

define Package/tvheadend-daemon/description
  Tvheadend is a TV streaming server for Linux supporting DVB-S, DVB-S2, DVB-C, DVB-T, ATSC, IPTV, and Analog video (V4L) as input sources.
  It also comes with a powerful and easy to use web interface both used for configuration and day-to-day operations,
  such as searching the EPG and scheduling recordings. 
  Even so, the most notable feature of Tvheadend is how easy it is to set up: Install it, navigate to the web user interface, 
  drill into the TV adapters tab, select your current location and Tvheadend will start scanning channels and present them to you in just 
  a few minutes
endef

define Package/tvheadend-web/description
 Webinterface resources for Tvheadend
endef

define Package/tvheadend-daemon/config
  menu "Configuration"
  depends on PACKAGE_tvheadend_daemon
  source "$(SOURCE)/Config.in"
  endmenu
endef

ifneq ($(CONFIG_TVHEADEND_AVAHI_SUPPORT),)
  CONFIGURE_ARGS+= --enable-avahi
else
  CONFIGURE_ARGS+= --disable-avahi
endif

CONFIGURE_ARGS += \
		--release 

TARGET_LDFLAGS += \
		-Wl,-rpath-link=$(STAGING_DIR)/usr/lib \
		-liconv
				
define Package/tvheadend-daemon/install
	$(INSTALL_DIR) $(1)/etc/init.d
	$(INSTALL_BIN) ./files/tvheadend.init $(1)/etc/init.d/tvheadend

	$(INSTALL_DIR) $(1)/usr/bin
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/build.linux/tvheadend $(1)/usr/bin/
endef

define Package/tvheadend-web/install
	$(INSTALL_DIR) $(1)/usr/share/tvheadend/src/webui
	$(CP) $(PKG_BUILD_DIR)/src/webui/static $(1)/usr/share/tvheadend/src/webui
endef

$(eval $(call BuildPackage,tvheadend-daemon))
$(eval $(call BuildPackage,tvheadend-web))
